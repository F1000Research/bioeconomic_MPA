#### Spatial base layer ####
# Protection scenarios (Figure 1)
print("Now calculating: Protection scenarios")

# MPA size frequency obtained from WDPA database downloaded from http://www.protectedplanet.net/search?marine=1 in March 2015
# calculations of MPA size frequency are done in MPA_size.org
MPA_size_dist_coast <- read.csv("MPA_size_dist_coast.csv")
MPA_size_dist_mar <- read.csv("MPA_size_dist_mar.csv")

# remove size distribution below grid size
MPA_size_dist_coast <- MPA_size_dist_coast[MPA_size_dist_coast$breaks>=log10(0.1*cell_size^2),]
MPA_size_dist_mar <- MPA_size_dist_mar[MPA_size_dist_mar$breaks>=log10(0.1*cell_size^2),]


#### load pre-existing MPAs ####
require(rgdal)
MPAs_coast <- readOGR(dsn=getwd(),layer="MPAs_coast")
MPAs_mar <- readOGR(dsn=getwd(),layer="MPAs_mar")
EEZ <- readOGR(dsn=getwd(),layer="eez_iho_union_v2")

# remove Canadian part of the Davis Strait for EEZ
EEZ <- EEZ[EEZ$marregion!="Canadian part of the Davis Strait",]

# standard projection
require(sp)
MPAs_coast <- spTransform(MPAs_coast,CRS(proj))
MPAs_mar <- spTransform(MPAs_mar,CRS(proj))
EEZ <- spTransform(EEZ,CRS(proj))
EEZ <- unionSpatialPolygons(EEZ,rep(1,length(EEZ)))

#### load DFO Area of Interest ####
# shapefile generated by georeferencing map images
# Maps downloaded from http://www.dfo-mpo.gc.ca/oceans/marineareas-zonesmarines/mpa-zpm/index-eng.htm
# MPAs_AOI <- readOGR(dsn=getwd(),layer="DFO_AreaOfInterest")
# MPAs_AOI <- spTransform(MPAs_AOI,CRS(proj))

#### load cod habitat and breeding sites ####
# shapefile generated by georeferencing figure 2 from Lough 2004
Habitats <- readOGR(dsn=getwd(),layer="cod_habitat")
Breeding <- readOGR(dsn=getwd(),layer="cod_breeding")
Habitats <- spTransform(Habitats,CRS(proj))
Breeding <- spTransform(Breeding,CRS(proj))
Habitats <- gIntersection(p,Habitats,byid=T, drop_not_poly=TRUE)
plot(Habitats)

#### plot MPAs ####
require(rgeos)
plot(EEZ)
plot(MPAs_coast,add=T,col='blue')
plot(MPAs_mar,add=T,col='red')
# plot(MPAs_AOI,add=T,col='green')

#### unique IDs ####
# MPAs_AOI <- spChFIDs(MPAs_AOI,paste("AOI",c(1:length(MPAs_AOI))))
MPAs_coast <- spChFIDs(MPAs_coast,paste("coast",c(1:length(MPAs_coast))))
MPAs_mar <- spChFIDs(MPAs_mar,paste("mar",c(1:length(MPAs_mar))))

#### rbind MPAs ####
MPAs <- rbind(MPAs_mar,MPAs_coast)
# MPAs <- rbind(MPAs,MPAs_AOI)

# remove Canadian part of the Davis Strait for MPA
MPAs <- MPAs[as.logical(gContains(EEZ,MPAs,byid=T)),]

#### ignore any MPAs smaller than 10% of grid size ####
MPAs <- MPAs[gArea(MPAs,byid=T)/(10^6)>(0.1*(cell_size^2)),]

#### match dataframe for p ####
df <- MPAs@data[1,]
df[,sapply(df, is.numeric)] <- 0
df[,sapply(df, is.numeric)==F] <- NA
df <- df[rep(1,length(p)),]
p <- SpatialPolygonsDataFrame(p,df,match.ID = F)
p <- spChFIDs(p,paste("p",c(1:length(p))))

#### match dataframe for Habitats ####
df <- MPAs@data[1,]
df[,sapply(df, is.numeric)] <- 0
df[,sapply(df, is.numeric)==F] <- NA
df <- df[rep(1,length(Habitats)),]
Habitats <- SpatialPolygonsDataFrame(Habitats,df,match.ID = F)
Habitats <- spChFIDs(Habitats,paste("hab",c(1:length(Habitats))))

#### make Canada (land) polygon for placement of coastal MPAs ####
data(wrld_simpl)
Canada <- wrld_simpl[wrld_simpl$NAME=="Canada", ]
Canada <- spTransform(Canada,CRS(proj))
rm(wrld_simpl)
plot(Canada)

coastal <- as.vector(gDistance(p,Canada,byid=T)<cell_size)
plot(p[coastal,])

if(protect_scen_new){
    
    #### place coastal MPAs ####
    #generate consistent sizing
    sizes <- generate_MPA_size(1000,MPA_size_dist_coast$cum_prob,MPA_size_dist_coast$breaks)
    tot_area <- gArea(EEZ)
    while(max(sizes)>MPA_coverage*tot_area){
        sizes[sizes>MPA_coverage*tot_area] <- generate_MPA_size(length(sizes[sizes>MPA_coverage*tot_area]),MPA_size_dist_coast$cum_prob,MPA_size_dist_coast$breaks)
    }
    
#     print("Establishing new coastal randomly placed MPAs")
#     MPAs_random <- generate_MPAs(sizes,MPAs,p[coastal,],p,MPA_coverage*CtoM,EEZ,"Random")
    
    print("Establishing new coastal maximum distance MPAs")
    MPAs_maxdist <- generate_MPAs(sizes,MPAs,p[coastal,],p,MPA_coverage*CtoM,EEZ,"MaxDist")

    print(paste0("Establishing new coastal fixed distance (",fixdist," km) MPAs"))
    MPAs_fixed <- generate_MPAs(sizes,MPAs,p[coastal,],p,MPA_coverage*CtoM,EEZ,fixdist)

    print(paste0("Establishing new coastal targeted with fixed distance (",fixdist," km) MPAs"))
    MPAs_targeted <- generate_MPAs(sizes,rbind(MPAs,Breeding),Habitats,Habitats,MPA_coverage*CtoM,EEZ,fixdist)

    #### place marine MPAs ####
    #generate consistent sizing
    sizes <- generate_MPA_size(1000,MPA_size_dist_mar$cum_prob,MPA_size_dist_mar$breaks)
    tot_area <- gArea(EEZ)
    while(max(sizes)>MPA_coverage*tot_area){
        sizes[sizes>MPA_coverage*tot_area] <- generate_MPA_size(length(sizes[sizes>MPA_coverage*tot_area]),MPA_size_dist_mar$cum_prob,MPA_size_dist_mar$breaks)
    }
    
#     print("Establishing new marine randomly placed MPAs")
#     MPAs_random <- generate_MPAs(sizes,MPAs_random,p,p,(MPA_coverage-(MPA_coverage*CtoM)),EEZ,"Random")

    print("Establishing new marine maximum distance MPAs")
    MPAs_maxdist <- generate_MPAs(sizes,MPAs_maxdist,p,p,(MPA_coverage-(MPA_coverage*CtoM)),EEZ,"MaxDist")
   
    print(paste0("Establishing new marine fixed distance (",fixdist," km) MPAs"))
    MPAs_fixed <- generate_MPAs(sizes,MPAs_fixed,p,p,(MPA_coverage-(MPA_coverage*CtoM)),EEZ,fixdist)

    print(paste0("Establishing new marine targeted with fixed distance (",fixdist," km) MPAs"))
    MPAs_targeted <- generate_MPAs(sizes,rbind(MPAs,Breeding),Habitats,Habitats,(MPA_coverage-(MPA_coverage*CtoM)),EEZ,fixdist)
    
    #### save scenarios ####
#     writeOGR(MPAs_random,dsn=getwd(), layer = "MPAs_random", driver = "ESRI Shapefile",overwrite_layer=T)
    writeOGR(MPAs_maxdist,dsn=getwd(), layer = "MPAs_maxdist", driver = "ESRI Shapefile",overwrite_layer=T)
    writeOGR(MPAs_fixed,dsn=getwd(), layer = "MPAs_fixed", driver = "ESRI Shapefile",overwrite_layer=T)
    writeOGR(MPAs_targeted,dsn=getwd(), layer = "MPAs_targeted", driver = "ESRI Shapefile",overwrite_layer=T)
    
} else {
#     MPAs_random <- readOGR(dsn=getwd(),layer="MPAs_random")
    MPAs_maxdist <- readOGR(dsn=getwd(),layer="MPAs_maxdist")
    MPAs_fixed <- readOGR(dsn=getwd(),layer="MPAs_fixed")
    MPAs_targeted <- readOGR(dsn=getwd(),layer="MPAs_targeted")
}

#### plots ####
# plot(EEZ)
# plot(MPAs_random,col="yellow",add=T)
# title("Random")

plot(EEZ)
plot(MPAs,col="yellow",add=T)
title("Status-quo")

plot(EEZ)
plot(MPAs_maxdist,col="green",add=T)
title("Max-Dist")

plot(EEZ)
plot(MPAs_fixed,col="red",add=T)
title("Fixed-Dist")

plot(EEZ)
plot(MPAs_targeted,col="blue",add=T)
title("Targeted MPAs")

